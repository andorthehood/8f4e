---
title: 'TODO: Auto-managed Environment Constants Block'
priority: Medium
effort: 2-4d
created: 2026-01-19
status: Completed
completed: 2026-01-19
---

# TODO: Auto-managed Environment Constants Block

## Problem Description

Environment constants (sample rate, buffer size, asset byte sizes) are currently injected via compiler options
(`environmentExtensions.constants`) instead of being expressed in source. This makes them harder to inspect,
version, and override, and it creates two sources of truth (compiler options vs. constants blocks). The goal
is to standardize on constants blocks only, with an auto-managed block generated by editor-state.

## Proposed Solution

Remove compiler support for injected environment constants and generate a dedicated constants block in
editor-state. The block is inserted first so user constants blocks can override values. It is automatically
updated when runtime settings or binary asset metadata change.

## Implementation Plan

### Step 1: Define the auto constants block contract
- Choose a reserved constants block name (for example `constants env`) and a stable marker string
- Define the emitted constants and formatting (sample rate, audio buffer size, binary asset sizes)
- Include a short warning comment in the block noting it is auto-generated and changes are overwritten
- Decide how to represent missing values (for example omit or set to 0)

### Step 2: Add editor-state effect to create and update the block
- Add a new editor-state feature that inserts the block if missing and keeps it updated
- Subscribe to changes in `compiledConfig`, `binaryAssets`, and any runtime buffer size source
- Ensure the block is ordered first among code blocks
- Avoid user edits in this block (regenerate on change)

### Step 3: Remove compiler injected constants support
- Delete `environmentExtensions.constants` from compiler option types and use sites
- Update editor-state to stop passing injected constants
- Update any other callers or tests that rely on injected constants

### Step 4: Tests and documentation
- Add editor-state tests for block creation, ordering, and updates
- Add compiler tests to confirm constants are only sourced from blocks
- Document the new behavior in editor-state and compiler docs

## Success Criteria

- [ ] Auto-managed constants block is always present and ordered first
- [ ] Sample rate, buffer size, and asset sizes are visible as `const` in source
- [ ] Compiler no longer accepts or uses injected environment constants
- [ ] Existing flows compile successfully with constants provided by the auto block

## Affected Components

- `packages/editor/packages/editor-state/src/features/program-compiler/effect.ts` - remove injected constants
- `packages/editor/packages/editor-state/src/index.ts` - register new effect
- `packages/editor/packages/editor-state/src/features/code-blocks` - block insertion and ordering
- `packages/editor/packages/editor-state/src/features/binary-assets` - provide asset sizes
- `packages/compiler/src` - remove constants injection option and related types

## Risks & Considerations

- **Ordering**: The block must be first so user constants override it
- **Runtime data**: Buffer size may not be available at compile time, define a source
- **Regeneration**: Ensure auto updates do not break undo or editing expectations
- **Breaking changes**: No backward compatibility needed; remove API support outright

## Related Items

- **Related**: `docs/todos/056-one-time-init-blocks-language-feature.md`
- **Related**: `docs/todos/180-config-binary-assets-from-urls.md`

## References

- `packages/editor/packages/editor-state/src/features/program-compiler/README.md`
- `packages/editor/packages/editor-state/src/features/code-blocks/README.md`
- `packages/editor/packages/editor-state/src/features/binary-assets/README.md`

## Notes

- The auto constants block should be treated as generated output and not user-edited
- Include a warning comment in the block since we cannot make it read-only yet
- Consider a reserved constants name to avoid collisions (for example `env`)

## Archive Instructions

When this TODO is completed:
1. Update the front matter to set `status: Completed` and provide the `completed` date
2. Move it to the `todo/archived/` folder to keep the main todo directory clean and organized
3. Update the `todo/_index.md` file to:
   - Move the TODO from the "Active TODOs" section to the "Completed TODOs" section
   - Add the completion date to the TODO entry (use `date +%Y-%m-%d` command if current date is not provided in the context)
