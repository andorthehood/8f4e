---
name: Deploy Editor Bundle to DigitalOcean Spaces

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DO_SPACES_BUCKET: ${{ vars.DO_SPACES_BUCKET }}   # e.g. polgar-assets
      DO_SPACES_REGION: ${{ vars.DO_SPACES_REGION }}   # e.g. ams3

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - run: npm ci
      - run: npx nx run-many --target=build --all
      - run: npm run bundle:editor

      # Prepare a tiny upload folder with SHA-versioned filenames
      - name: Stage versioned files
        run: |
          mkdir -p upload
          cp packages/editor/bundle/editor-bundle.js "upload/editor-bundle-${GITHUB_SHA}.js"
          cp packages/editor/bundle/editor-bundle.js.map "upload/editor-bundle-${GITHUB_SHA}.js.map"

      # Upload to Spaces (public by default)
      - name: DigitalOcean Spaces Upload Action
        uses: BetaHuhn/do-spaces-action@v2.0.146
        with:
          access_key: ${{ secrets.DO_SPACES_ACCESS_KEY }}
          secret_key: ${{ secrets.DO_SPACES_SECRET_KEY }}
          space_name: ${{ env.DO_SPACES_BUCKET }}
          space_region: ${{ env.DO_SPACES_REGION }}
          source: upload
          out_dir: editor