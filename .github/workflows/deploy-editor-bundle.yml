---
name: Deploy Editor Bundle to DigitalOcean Spaces

on:
  push:
    branches: [main]
    paths:
      - 'packages/editor/**'
      - '.github/workflows/deploy-editor-bundle.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DO_SPACES_BUCKET: ${{ vars.DO_SPACES_BUCKET }}
      DO_SPACES_REGION: ${{ vars.DO_SPACES_REGION }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Read editor package version
        id: editor_version
        run: |
          EDITOR_VERSION=$(node -p "require('./packages/editor/package.json').version")
          echo "EDITOR_VERSION=$EDITOR_VERSION" >> $GITHUB_ENV
          echo "value=$EDITOR_VERSION" >> "$GITHUB_OUTPUT"

      - name: Check if bundle version already exists
        id: check_bundle
        run: |
          set -euo pipefail
          BUNDLE_URL="https://${DO_SPACES_BUCKET}.${DO_SPACES_REGION}.digitaloceanspaces.com/andor/8f4e/editor-bundle-${EDITOR_VERSION}.js"
          if curl -sfI "$BUNDLE_URL" >/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Bundle $BUNDLE_URL already present; skipping upload."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Bundle $BUNDLE_URL not found; continuing with upload."
          fi

      - run: npm ci
        if: steps.check_bundle.outputs.exists == 'false'

      - run: npx nx run-many --target=build --all
        if: steps.check_bundle.outputs.exists == 'false'

      - run: npx nx run editor:bundle
        if: steps.check_bundle.outputs.exists == 'false'

      # Prepare a tiny upload folder with package-versioned filenames
      - name: Stage versioned files
        if: steps.check_bundle.outputs.exists == 'false'
        run: |
          mkdir -p upload
          cp packages/editor/bundle/editor-bundle.js "upload/editor-bundle-${EDITOR_VERSION}.js"
          cp packages/editor/bundle/editor-bundle.js.map "upload/editor-bundle-${EDITOR_VERSION}.js.map"

      # Upload to Spaces (public by default)
      - name: DigitalOcean Spaces Upload Action
        if: steps.check_bundle.outputs.exists == 'false'
        uses: BetaHuhn/do-spaces-action@v2.0.146
        with:
          access_key: ${{ secrets.DO_SPACES_ACCESS_KEY }}
          secret_key: ${{ secrets.DO_SPACES_SECRET_KEY }}
          space_name: ${{ env.DO_SPACES_BUCKET }}
          space_region: ${{ env.DO_SPACES_REGION }}
          source: upload
          out_dir: andor/8f4e
